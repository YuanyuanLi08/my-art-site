<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grid Coordinates Art Space</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #ffffff;
      --ink: #111111;
      --gallery-w: min(84vw, 1260px);
      --map-ratio: 1 / 1;
      --dur: 420ms;
      --ease: cubic-bezier(0.2, 0.7, 0.2, 1);
      --map-bg: url("./assets/map-bg.jpg");
      --map-icon-bg: url("./assets/map-bg icon.jpg");
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      color: var(--ink);
      font-family: "Space Grotesk", "Avenir Next", "Helvetica Neue", sans-serif;
      overflow: hidden;
    }

    .app {
      width: 100vw;
      height: 100vh;
      display: grid;
      place-items: center;
      position: relative;
      background: #fff;
    }

    .desktop-block {
      position: absolute;
      inset: 0;
      background: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: clamp(1rem, 2vw, 1.4rem);
      z-index: 80;
      padding: 2rem;
    }

    .desktop-block.active {
      display: flex;
    }

    .stage {
      width: min(90vw, calc(90vh * var(--map-ratio)), 1000px);
      max-width: 1000px;
      aspect-ratio: var(--map-ratio);
      height: auto;
      position: relative;
      overflow: hidden;
      background: #fff;
      transition: width var(--dur) var(--ease), height var(--dur) var(--ease);
    }

    .stage.level-3 {
      width: 100vw;
      height: 100vh;
    }

    .view {
      position: absolute;
      inset: 0;
      opacity: 0;
      pointer-events: none;
      transition: opacity 240ms ease;
      background: #fff;
    }

    .view.active {
      opacity: 1;
      pointer-events: auto;
    }

    .map-layer {
      position: absolute;
      inset: 0;
      background-color: #fff;
      background-repeat: no-repeat;
      background-position: center;
      background-size: contain;
    }

    .label-layer,
    .reference-layer,
    .hotspot-layer {
      position: absolute;
      inset: 0;
    }

    .label-layer {
      pointer-events: none;
      z-index: 8;
    }

    .reference-layer {
      pointer-events: none;
      z-index: 7;
      background-image: var(--map-icon-bg);
      background-repeat: no-repeat;
      background-position: center;
      background-size: contain;
      opacity: 0;
      transition: opacity 180ms ease;
    }

    body.debug-reference .reference-layer {
      opacity: 0.32;
    }

    .hotspot-layer {
      z-index: 12;
    }

    #l1Map {
      background-image: var(--map-bg);
    }

    #l2Map {
      background-image: var(--map-bg);
    }

    .hotspot {
      position: absolute;
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0;
      margin: 0;
      transition: background 180ms ease;
    }

    .hotspot:hover {
      background: rgba(12, 12, 12, 0.08);
    }

    body.debug-hotspots .hotspot {
      background: rgba(255, 0, 0, 0.12);
      outline: 1px solid rgba(255, 0, 0, 0.4);
    }

    .map-label,
    .coordinate-text {
      position: absolute;
      left: 0;
      top: 0;
      color: #111111;
      font-size: clamp(14px, 1.4vw, 30px);
      font-weight: 600;
      letter-spacing: 0.01em;
      white-space: nowrap;
      transform: translate3d(calc(-50% + var(--mx, 0px)), calc(-50% + var(--my, 0px)), 0);
      opacity: var(--op, 0.6);
      will-change: transform;
      transition: opacity 220ms ease-out;
    }

    .map-label.muted,
    .coordinate-text.muted {
      font-weight: 500;
    }

    .icon-btn {
      position: absolute;
      width: 34px;
      height: 34px;
      border: 1px solid rgba(10, 10, 10, 0.28);
      background: #fff;
      color: #111;
      display: grid;
      place-items: center;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      font: inherit;
      font-size: 1.06rem;
      z-index: 30;
    }

    #backBtn {
      top: 14px;
      left: 14px;
      display: none;
    }

    #backBtn.visible {
      display: grid;
    }

    .l3-shell {
      width: 100%;
      height: 100%;
      position: relative;
      background: #fff;
    }

    .mode-switch {
      position: absolute;
      top: 14px;
      right: 14px;
      display: flex;
      gap: 8px;
      z-index: 20;
    }

    .mode-btn {
      width: 34px;
      height: 34px;
      border: 1px solid rgba(10, 10, 10, 0.28);
      background: #fff;
      color: #111;
      display: grid;
      place-items: center;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      font: inherit;
      font-size: 1rem;
    }

    .mode-btn.active {
      background: #111;
      color: #fff;
    }

    .loop-panel {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #fff;
    }

    .h-track {
      height: 100%;
      display: flex;
      transition: transform 380ms var(--ease);
      touch-action: pan-y;
    }

    .h-slide {
      flex: 0 0 100%;
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
      cursor: pointer;
      position: relative;
      padding: 60px 72px;
    }

    .media-shell {
      width: 100%;
      height: 100%;
      display: grid;
      align-content: center;
      justify-items: center;
      gap: 14px;
    }

    .media-shell img,
    .media-shell video {
      width: 100%;
      height: min(78vh, 82%);
      object-fit: contain;
      background: #f2f2f2;
    }

    .meta {
      width: 100%;
      font-size: 0.9rem;
      line-height: 1.35;
      display: grid;
      gap: 2px;
      justify-items: start;
    }

    .h-arrow {
      top: 50%;
      transform: translateY(-50%);
      z-index: 12;
    }

    .h-arrow.prev {
      left: 14px;
    }

    .h-arrow.next {
      right: 14px;
    }

    .v-scroll {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      scroll-behavior: smooth;
      scrollbar-width: thin;
    }

    .v-list {
      width: 100%;
      display: grid;
      gap: 0;
    }

    .v-item {
      min-height: 100vh;
      padding: 60px 72px;
      display: grid;
      align-content: center;
      cursor: pointer;
      background: #fff;
    }

    .v-item img,
    .v-item video {
      width: 100%;
      height: min(78vh, 82%);
      object-fit: contain;
      background: #f2f2f2;
    }

    .zoom-ghost {
      position: fixed;
      border: 1px solid rgba(20, 20, 20, 0.18);
      background: #fff;
      z-index: 60;
      pointer-events: none;
      transition: all var(--dur) var(--ease);
    }

    .modal {
      position: absolute;
      inset: 0;
      z-index: 50;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: rgba(0, 0, 0, 0.32);
      backdrop-filter: blur(6px);
    }

    .modal.active {
      display: flex;
    }

    .modal-card {
      width: min(86vw, 1100px);
      max-height: 92vh;
      overflow: auto;
      background: #fff;
      padding: 18px;
      display: grid;
      gap: 14px;
      position: relative;
    }

    .modal-card img,
    .modal-card video {
      width: 100%;
      max-height: 74vh;
      object-fit: contain;
      background: #f1f1f1;
    }

    .close {
      right: 10px;
      top: 10px;
      position: absolute;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="desktop-block" id="mobileBlock">艺术体验仅限桌面端开启，请于电脑端访问 yuanyuanli.art</div>
    <button class="icon-btn" id="backBtn" type="button" aria-label="Back">←</button>

    <main class="stage" id="stage">
      <section class="view active" id="viewL1">
        <div class="map-layer" id="l1Map"></div>
        <div class="reference-layer"></div>
        <div class="label-layer" id="l1LabelLayer"></div>
        <div class="hotspot-layer" id="l1HotspotLayer"></div>
      </section>

      <section class="view" id="viewL2">
        <div class="map-layer" id="l2Map"></div>
        <div class="reference-layer"></div>
        <div class="label-layer" id="l2LabelLayer"></div>
        <div class="hotspot-layer" id="l2HotspotLayer"></div>
      </section>

      <section class="view" id="viewL3">
        <div class="l3-shell">
          <div class="mode-switch">
            <button class="mode-btn active" data-mode="horizontal" type="button" aria-label="Horizontal loop">↔</button>
            <button class="mode-btn" data-mode="vertical" type="button" aria-label="Vertical loop">↕</button>
          </div>
          <div class="loop-panel" id="l3Panel"></div>
        </div>
      </section>

      <div class="modal" id="artModal">
        <article class="modal-card" id="modalCard"></article>
      </div>
    </main>
  </div>

  <script>
    const state = {
      level: 1,
      selectedL1: null,
      selectedL2: null,
      l3Mode: "horizontal",
      hIndex: 1,
      desktopInteractive: true,
      triggerRects: {
        2: null,
        3: null
      }
    };

    const stage = document.getElementById("stage");
    const backBtn = document.getElementById("backBtn");
    const viewL1 = document.getElementById("viewL1");
    const viewL2 = document.getElementById("viewL2");
    const viewL3 = document.getElementById("viewL3");
    const l1Map = document.getElementById("l1Map");
    const l2Map = document.getElementById("l2Map");
    const l1LabelLayer = document.getElementById("l1LabelLayer");
    const l2LabelLayer = document.getElementById("l2LabelLayer");
    const l1HotspotLayer = document.getElementById("l1HotspotLayer");
    const l2HotspotLayer = document.getElementById("l2HotspotLayer");
    const l3Panel = document.getElementById("l3Panel");
    const mobileBlock = document.getElementById("mobileBlock");
    const modal = document.getElementById("artModal");
    const modalCard = document.getElementById("modalCard");

    // Coordinates are defined inside the hand-drawn square region.
    const mapCells = [
      { id: 1, x: 3, y: 2, w: 21, h: 20 },
      { id: 2, x: 25, y: 2, w: 22, h: 20 },
      { id: 3, x: 48, y: 2, w: 22, h: 20 },
      { id: 4, x: 71, y: 2, w: 25, h: 20 },
      { id: 5, x: 25, y: 23, w: 45, h: 22 },
      { id: 6, x: 3, y: 23, w: 21, h: 22 },
      { id: 7, x: 48, y: 46, w: 22, h: 20 },
      { id: 8, x: 71, y: 46, w: 12, h: 20 },
      { id: 9, x: 84, y: 46, w: 12, h: 20 },
      { id: 10, x: 25, y: 69, w: 22, h: 24 },
      { id: 11, x: 48, y: 69, w: 22, h: 24 },
      { id: 12, x: 71, y: 69, w: 25, h: 24 }
    ];

    // Fine-tune these 4 values to align hotspots to your background.
    // x/y/w/h are percentages in the full source image.
    const mapFrame = { x: 3.1, y: 17.8, w: 93.2, h: 69.4 };
    const DEBUG_HOTSPOTS = false;
    const DEBUG_REFERENCE = false;
    const MAGNETIC_RADIUS = 150;
    const MAGNETIC_MAX_SHIFT = 8;
    const MAGNETIC_LERP = 0.16;

    if (DEBUG_HOTSPOTS) document.body.classList.add("debug-hotspots");
    if (DEBUG_REFERENCE) document.body.classList.add("debug-reference");

    const pointer = { x: 0, y: 0, active: false };
    const magneticState = new WeakMap();

    // L1 icon layer text: editable coordinate list (frame-relative percentages).
    const l1TextLayout = [
      { id: 1, text: "I..I", x: 14, y: 10.2, muted: false },
      { id: 2, text: "I.II..I", x: 38, y: 20.4, muted: true },
      { id: 3, text: "I.III..I", x: 62, y: 20.4, muted: true },
      { id: 4, text: "II.III..I", x: 86, y: 20.4, muted: true },
      { id: 5, text: "I.II..II", x: 45.5, y: 39.8, muted: true },
      { id: 6, text: "II..I", x: 14, y: 39.8, muted: false },
      { id: 7, text: "II..II", x: 38, y: 58.2, muted: true },
      { id: 8, text: "III..II", x: 62, y: 58.2, muted: true },
      { id: 9, text: "I.III..II", x: 86, y: 58.2, muted: false },
      { id: 10, text: "I..III", x: 14, y: 78.8, muted: true },
      { id: 11, text: "II..III", x: 38, y: 78.8, muted: true },
      { id: 12, text: "II.III..III", x: 86, y: 78.8, muted: false }
    ];

    // L2 index layer text: editable coordinate list (frame-relative percentages).
    const l2TextLayout = [
      { id: 1, text: "1", x: 31.5, y: 11.4 },
      { id: 2, text: "2", x: 50.5, y: 11.4 },
      { id: 3, text: "3", x: 69.5, y: 11.4 },
      { id: 4, text: "4", x: 83.8, y: 11.4 },
      { id: 5, text: "5", x: 50.0, y: 28.2 },
      { id: 6, text: "6", x: 15.5, y: 28.2 },
      { id: 7, text: "7", x: 50.8, y: 45.0 },
      { id: 8, text: "8", x: 69.8, y: 45.0 },
      { id: 9, text: "9", x: 84.5, y: 45.0 },
      { id: 10, text: "10", x: 30.2, y: 72.4 },
      { id: 11, text: "11", x: 49.2, y: 72.4 },
      { id: 12, text: "12", x: 69.2, y: 72.4 }
    ];

    const seriesMap = Object.fromEntries(
      mapCells.map((cell, idx) => {
        const base = `L1.${String(cell.id).padStart(2, "0")}`;
        return [
          cell.id,
          {
            title: `${base}`,
            index: Array.from({ length: 6 }, (_, i) => ({
              id: `${base}.${i + 1}`,
              label: `${i + 1}`,
              mode: (idx + i) % 2 === 0 ? "horizontal" : "vertical",
              works: buildWorks(base, i + 1)
            }))
          }
        ];
      })
    );

    function buildWorks(base, step) {
      return [
        {
          id: `${base}.${step}.A`,
          title: `No Straight Line #${step}`,
          year: "2026",
          medium: "Works on Paper",
          size: "40cm x 40cm",
          type: "image",
          src: `https://picsum.photos/seed/${encodeURIComponent(base + step + "a")}/1400/1200`
        },
        {
          id: `${base}.${step}.B`,
          title: `Drift Study #${step}`,
          year: "2026",
          medium: "Single Channel Video",
          size: "00:30",
          type: "video",
          src: "https://www.w3schools.com/html/mov_bbb.mp4"
        },
        {
          id: `${base}.${step}.C`,
          title: `Breath Line #${step}`,
          year: "2026",
          medium: "Audio Sketch",
          size: "02:13",
          type: "audio",
          src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"
        },
        {
          id: `${base}.${step}.D`,
          title: `Grid Echo #${step}`,
          year: "2026",
          medium: "Works on Paper",
          size: "60cm x 45cm",
          type: "image",
          src: `https://picsum.photos/seed/${encodeURIComponent(base + step + "d")}/1400/1100`
        }
      ];
    }

    function toLayerRect(cell) {
      return {
        id: cell.id,
        x: mapFrame.x + (cell.x * mapFrame.w) / 100,
        y: mapFrame.y + (cell.y * mapFrame.h) / 100,
        w: (cell.w * mapFrame.w) / 100,
        h: (cell.h * mapFrame.h) / 100
      };
    }

    function toLayerPoint(point) {
      return {
        id: point.id,
        text: point.text,
        muted: Boolean(point.muted),
        x: mapFrame.x + (point.x * mapFrame.w) / 100,
        y: mapFrame.y + (point.y * mapFrame.h) / 100
      };
    }

    function renderLabelLayer(container, layout) {
      container.innerHTML = "";
      layout.forEach((item) => {
        const p = toLayerPoint(item);
        const el = document.createElement("span");
        el.className = `map-label coordinate-text${p.muted ? " muted" : ""}`;
        el.dataset.mag = "1";
        el.dataset.baseOpacity = p.muted ? "0.5" : "0.6";
        el.style.left = `${p.x.toFixed(3)}%`;
        el.style.top = `${p.y.toFixed(3)}%`;
        el.style.setProperty("--op", el.dataset.baseOpacity);
        el.textContent = p.text;
        magneticState.set(el, { x: 0, y: 0, o: Number(el.dataset.baseOpacity) });
        container.appendChild(el);
      });
    }

    function addHotspot(container, config, onClick) {
      const tile = document.createElement("button");
      tile.className = "hotspot";
      tile.type = "button";
      tile.setAttribute("aria-label", `Cell ${config.id}`);
      tile.style.left = `${config.x.toFixed(3)}%`;
      tile.style.top = `${config.y.toFixed(3)}%`;
      tile.style.width = `${config.w.toFixed(3)}%`;
      tile.style.height = `${config.h.toFixed(3)}%`;
      tile.addEventListener("click", () => onClick(tile));
      container.appendChild(tile);
    }

    function renderL1() {
      l1HotspotLayer.innerHTML = "";
      renderLabelLayer(l1LabelLayer, l1TextLayout);
      mapCells.forEach((cell) => {
        addHotspot(l1HotspotLayer, toLayerRect(cell), (tile) => {
          state.selectedL1 = cell.id;
          state.triggerRects[2] = tile.getBoundingClientRect();
          renderL2(cell.id);
          transitionTo(2, state.triggerRects[2]);
        });
      });
    }

    function renderL2(groupId) {
      l2HotspotLayer.innerHTML = "";
      renderLabelLayer(l2LabelLayer, l2TextLayout);
      const data = seriesMap[groupId];
      mapCells.forEach((cell) => {
        const entry = data.index[(cell.id - 1) % data.index.length];
        addHotspot(
          l2HotspotLayer,
          toLayerRect(cell),
          (tile) => {
            state.selectedL2 = entry.id;
            state.l3Mode = entry.mode;
            state.triggerRects[3] = tile.getBoundingClientRect();
            renderL3(entry);
            transitionTo(3, state.triggerRects[3]);
          }
        );
      });
    }

    function getActiveLabels() {
      if (state.level === 1) return l1LabelLayer.querySelectorAll(".map-label[data-mag='1']");
      if (state.level === 2) return l2LabelLayer.querySelectorAll(".map-label[data-mag='1']");
      return [];
    }

    function resetMagnetic() {
      const labels = document.querySelectorAll(".map-label[data-mag='1']");
      labels.forEach((el) => {
        const baseOpacity = Number(el.dataset.baseOpacity || "0.6");
        const m = magneticState.get(el) || { x: 0, y: 0, o: baseOpacity };
        m.x = 0;
        m.y = 0;
        m.o = baseOpacity;
        magneticState.set(el, m);
        el.style.setProperty("--mx", "0px");
        el.style.setProperty("--my", "0px");
        el.style.setProperty("--op", baseOpacity.toFixed(2));
      });
    }

    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    function animateMagnetic() {
      if (!state.desktopInteractive) {
        requestAnimationFrame(animateMagnetic);
        return;
      }
      const labels = getActiveLabels();
      labels.forEach((el) => {
        const rect = el.getBoundingClientRect();
        const cx = rect.left + rect.width / 2;
        const cy = rect.top + rect.height / 2;
        const dx = pointer.x - cx;
        const dy = pointer.y - cy;
        const dist = Math.hypot(dx, dy);
        let targetX = 0;
        let targetY = 0;
        const baseOpacity = Number(el.dataset.baseOpacity || "0.6");
        let targetOpacity = baseOpacity;

        if (pointer.active && dist < MAGNETIC_RADIUS && dist > 0.001) {
          const proximity = 1 - dist / MAGNETIC_RADIUS;
          const strength = proximity * 0.08;
          targetX = dx * strength;
          targetY = dy * strength;
          const capped = Math.hypot(targetX, targetY);
          if (capped > MAGNETIC_MAX_SHIFT) {
            const k = MAGNETIC_MAX_SHIFT / capped;
            targetX *= k;
            targetY *= k;
          }
          targetOpacity = clamp(baseOpacity + proximity * (1 - baseOpacity), 0, 1);
        }

        const m = magneticState.get(el) || { x: 0, y: 0, o: baseOpacity };
        m.x += (targetX - m.x) * MAGNETIC_LERP;
        m.y += (targetY - m.y) * MAGNETIC_LERP;
        m.o += (targetOpacity - m.o) * MAGNETIC_LERP;
        magneticState.set(el, m);
        el.style.setProperty("--mx", `${m.x.toFixed(2)}px`);
        el.style.setProperty("--my", `${m.y.toFixed(2)}px`);
        el.style.setProperty("--op", clamp(m.o, 0, 1).toFixed(2));
      });
      requestAnimationFrame(animateMagnetic);
    }

    function mediaPreview(work) {
      if (work.type === "image") {
        return `<img src="${work.src}" alt="${work.title}" loading="lazy" />`;
      }
      if (work.type === "video") {
        return `<video src="${work.src}" muted playsinline></video>`;
      }
      return `<audio controls preload="none" src="${work.src}" style="width:min(92%,720px)"></audio>`;
    }

    function metaTemplate(work, prefix = "") {
      return `
        <div class="meta">
          <strong>${prefix}${work.title}</strong>
          <span>${work.medium}</span>
          <span>${work.year}</span>
          <span>${work.size}</span>
        </div>`;
    }

    function renderL3(entry) {
      const modeButtons = document.querySelectorAll(".mode-btn");
      modeButtons.forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.mode === state.l3Mode);
        btn.onclick = () => {
          state.l3Mode = btn.dataset.mode;
          modeButtons.forEach((b) => b.classList.toggle("active", b === btn));
          renderL3Content(entry);
        };
      });
      renderL3Content(entry);
    }

    function renderL3Content(entry) {
      if (state.l3Mode === "horizontal") {
        renderHorizontalLoop(entry.works);
      } else {
        renderVerticalLoop(entry.works);
      }
    }

    function renderHorizontalLoop(works) {
      l3Panel.innerHTML = "";
      l3Panel.onwheel = null;

      const prev = document.createElement("button");
      prev.className = "icon-btn h-arrow prev";
      prev.type = "button";
      prev.setAttribute("aria-label", "Previous");
      prev.textContent = "←";

      const next = document.createElement("button");
      next.className = "icon-btn h-arrow next";
      next.type = "button";
      next.setAttribute("aria-label", "Next");
      next.textContent = "→";

      const track = document.createElement("div");
      track.className = "h-track";
      const buffer = [works[works.length - 1], ...works, works[0]];
      state.hIndex = 1;

      buffer.forEach((work) => {
        const slide = document.createElement("article");
        slide.className = "h-slide";
        slide.innerHTML = `
          <div class="media-shell">
            ${mediaPreview(work)}
            ${metaTemplate(work)}
          </div>`;
        slide.addEventListener("click", () => openModal(work));
        track.appendChild(slide);
      });

      function update(animated = true) {
        track.style.transition = animated ? "transform 380ms var(--ease)" : "none";
        track.style.transform = `translateX(-${state.hIndex * 100}%)`;
      }

      function step(dir) {
        state.hIndex += dir;
        update(true);
      }

      track.addEventListener("transitionend", () => {
        if (state.hIndex === 0) {
          state.hIndex = works.length;
          update(false);
        }
        if (state.hIndex === works.length + 1) {
          state.hIndex = 1;
          update(false);
        }
      });

      l3Panel.onwheel = (event) => {
        event.preventDefault();
        step(event.deltaY > 0 ? 1 : -1);
      };

      prev.onclick = () => step(-1);
      next.onclick = () => step(1);

      l3Panel.append(prev, track, next);
      update(false);
    }

    function renderVerticalLoop(works) {
      l3Panel.innerHTML = `
        <div class="v-scroll" id="vScroll">
          <div class="v-list" id="vList"></div>
        </div>`;
      l3Panel.onwheel = null;

      const vScroll = document.getElementById("vScroll");
      const vList = document.getElementById("vList");

      const chunk = [...works, ...works, ...works];
      chunk.forEach((work, i) => {
        const item = document.createElement("article");
        const prefix = `#${(i % works.length) + 1} · `;
        item.className = "v-item";
        item.innerHTML = `
          <div class="media-shell">
            ${mediaPreview(work)}
            ${metaTemplate(work, prefix)}
          </div>`;
        item.addEventListener("click", () => openModal(work));
        vList.appendChild(item);
      });

      requestAnimationFrame(() => {
        const oneSetHeight = vList.scrollHeight / 3;
        vScroll.scrollTop = oneSetHeight;

        vScroll.onscroll = () => {
          if (vScroll.scrollTop <= oneSetHeight * 0.2) {
            vScroll.scrollTop += oneSetHeight;
          }
          if (vScroll.scrollTop >= oneSetHeight * 1.8) {
            vScroll.scrollTop -= oneSetHeight;
          }
        };
      });
    }

    function openModal(work) {
      modalCard.innerHTML = `
        <button class="icon-btn close" type="button" id="closeModal" aria-label="Close">✖</button>
        ${work.type === "image" ? `<img src="${work.src}" alt="${work.title}" />` : ""}
        ${work.type === "video" ? `<video controls autoplay src="${work.src}"></video>` : ""}
        ${work.type === "audio" ? `<audio controls autoplay src="${work.src}" style="width:100%"></audio>` : ""}
        ${metaTemplate(work)}
      `;
      modal.classList.add("active");
      document.getElementById("closeModal").onclick = closeModal;
    }

    function closeModal() {
      modal.classList.remove("active");
      modalCard.innerHTML = "";
    }

    modal.addEventListener("click", (event) => {
      if (event.target === modal) closeModal();
    });

    function switchLevel(level) {
      state.level = level;
      stage.classList.toggle("level-3", level === 3);
      [viewL1, viewL2, viewL3].forEach((view, index) => {
        view.classList.toggle("active", index + 1 === level);
      });
      backBtn.classList.toggle("visible", level > 1);
      if (level > 2) {
        pointer.active = false;
        resetMagnetic();
      }
    }

    function getTargetRect(level) {
      if (level === 3) {
        return { left: 0, top: 0, width: window.innerWidth, height: window.innerHeight };
      }
      return stage.getBoundingClientRect();
    }

    function transitionTo(level, fromRect) {
      const toRect = getTargetRect(level);
      if (!fromRect) {
        switchLevel(level);
        return;
      }

      const ghost = document.createElement("div");
      ghost.className = "zoom-ghost";
      ghost.style.left = `${fromRect.left}px`;
      ghost.style.top = `${fromRect.top}px`;
      ghost.style.width = `${fromRect.width}px`;
      ghost.style.height = `${fromRect.height}px`;
      document.body.appendChild(ghost);

      requestAnimationFrame(() => {
        ghost.style.left = `${toRect.left}px`;
        ghost.style.top = `${toRect.top}px`;
        ghost.style.width = `${toRect.width}px`;
        ghost.style.height = `${toRect.height}px`;
      });

      setTimeout(() => {
        switchLevel(level);
      }, 220);

      ghost.addEventListener("transitionend", () => ghost.remove(), { once: true });
    }

    function zoomBack() {
      if (state.level === 1) return;
      closeModal();

      const fromRect = getTargetRect(state.level);
      const nextLevel = state.level - 1;
      const toRect = state.triggerRects[state.level];

      if (!toRect) {
        switchLevel(nextLevel);
        return;
      }

      const ghost = document.createElement("div");
      ghost.className = "zoom-ghost";
      ghost.style.left = `${fromRect.left}px`;
      ghost.style.top = `${fromRect.top}px`;
      ghost.style.width = `${fromRect.width}px`;
      ghost.style.height = `${fromRect.height}px`;
      document.body.appendChild(ghost);

      switchLevel(nextLevel);
      requestAnimationFrame(() => {
        ghost.style.left = `${toRect.left}px`;
        ghost.style.top = `${toRect.top}px`;
        ghost.style.width = `${toRect.width}px`;
        ghost.style.height = `${toRect.height}px`;
      });

      ghost.addEventListener("transitionend", () => ghost.remove(), { once: true });
    }

    function checkDevice() {
      const isMobile = window.innerWidth < 1024 || window.matchMedia("(pointer: coarse)").matches;
      mobileBlock.classList.toggle("active", isMobile);
      state.desktopInteractive = !isMobile;
      if (isMobile) {
        pointer.active = false;
        resetMagnetic();
      }
    }

    backBtn.addEventListener("click", zoomBack);

    window.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        if (modal.classList.contains("active")) {
          closeModal();
        } else {
          zoomBack();
        }
      }
    });

    window.addEventListener("resize", checkDevice);
    window.addEventListener("mousemove", (event) => {
      if (!state.desktopInteractive || state.level > 2) return;
      pointer.x = event.clientX;
      pointer.y = event.clientY;
      pointer.active = true;
    });
    document.addEventListener("mouseleave", () => {
      pointer.active = false;
    });
    window.addEventListener("blur", () => {
      pointer.active = false;
    });

    renderL1();
    checkDevice();
    animateMagnetic();
  </script>
</body>
</html>
